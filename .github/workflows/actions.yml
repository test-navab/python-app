name: Docker Build and Push

on:
  push:
    branches:
      - live
      - beta

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Extract commit messages
      id: extract_commits
      run: |
        commit_message=$(git log --pretty=format:'%s' -n 1)
        echo "Commit message: $commit_message"
        
        db_migrate_seed=false
        db_migrate=false
        db_seed=false

        if echo "$commit_message" | grep -iq 'db-migrate-seed'; then
          db_migrate_seed=true
        elif echo "$commit_message" | grep -iq 'db-migrate'; then
          db_migrate=true
        elif echo "$commit_message" | grep -iq 'db-seed'; then
          db_seed=true
        fi

        echo "::set-output name=db_migrate_seed::$db_migrate_seed"
        echo "::set-output name=db_migrate::$db_migrate"
        echo "::set-output name=db_seed::$db_seed"
    outputs:
      db_migrate_seed: ${{ steps.extract_commits.outputs.db_migrate_seed }}
      db_migrate: ${{ steps.extract_commits.outputs.db_migrate }}
      db_seed: ${{ steps.extract_commits.outputs.db_seed }}


  db-migrate:
    runs-on: ubuntu-latest
    needs: [build]
    if: needs.build.outputs.db_migrate == 'true' || needs.build.outputs.db_seed == 'true' || needs.build.outputs.db_migrate_seed == 'true'
    steps:
    - name: Run DB migration or seed
      run: |
        if [ "${{ needs.build.outputs.db_migrate_seed }}" == "true" ]; then
          echo "Running DB Migrate and Seed"
        elif [ "${{ needs.build.outputs.db_migrate }}" == "true" ]; then
          echo "Running DB Migrate"
        elif [ "${{ needs.build.outputs.db_seed }}" == "true" ]; then
          echo "Running DB Seed"
        fi

    # - name: Print environment variables
    #   run: |
    #     echo "db_migrate: $db_migrate"
    #     echo "db_seed: $db_seed"
    #     echo "db_migrate_seed: $db_migrate_seed"

    # - name: Set image tags
    #   id: vars
    #   run: |
    #     echo "commit_sha=$(echo $GITHUB_SHA | head -c 8)" >> $GITHUB_ENV


    # - name: Build and Push Docker Image
    #   env:
    #     REPO_NAME: ${{ github.event.repository.name }}
    #     BRANCH_NAME: ${{ github.ref_name }}
    #   run: |
    #     docker build -t ghcr.io/${{ github.repository_owner }}/${REPO_NAME}-${BRANCH_NAME}:${{ env.commit_sha }} .
    #     docker push ghcr.io/${{ github.repository_owner }}/${REPO_NAME}-${BRANCH_NAME}:${{ env.commit_sha }}


    # - name: executing remote ssh commands using ssh key
    #   env:
    #     REPO_NAME: ${{ github.event.repository.name }}
    #   uses: appleboy/ssh-action@v1.2.0
    #   with:
    #     host: 80.248.196.125
    #     username: jenkins
    #     key: ${{ secrets.SSH_PRIVATE_KEY }}
    #     port: 30102
    #     script: ansible-playbook /var/lib/jenkins/cicd/github-actions/main.yaml -e tag=${{ env.commit_sha }} -e ProjectName=${{ env.REPO_NAME }}

    # - name: Set environment variables based on branch
    #   id: set-env
    #   run: |
    #     if [ "${{ github.ref_name }}" == "beta" ]; then
    #       echo "PORT=30111" >> $GITHUB_ENV
    #       echo "USER_NAME=ubuntu" >> $GITHUB_ENV
    #     elif [ "${{ github.ref_name }}" == "live" ]; then
    #       echo "PORT=30121" >> $GITHUB_ENV
    #       echo "USER_NAME=edexauniverse" >> $GITHUB_ENV
    #     else
    #       echo "Unsupported branch: ${{ github.ref_name }}"
    #       exit 1
    #     fi

    # - name: Set environment variables based on branch
    #   id: set-env
    #   run: |
    #     if [ "${{ github.ref_name }}" == "beta" ]; then
    #       echo "PORT=30111" >> $GITHUB_ENV
    #       echo "USER_NAME=ubuntu" >> $GITHUB_ENV
    #       echo "DEST_DIR=/home/ubuntu/github-actions/python-app/helmtemplate" >> $GITHUB_ENV
    #       echo "ROOT_DIR=/home/ubuntu/github-actions/python-app" >> $GITHUB_ENV
    #     elif [ "${{ github.ref_name }}" == "live" ]; then
    #       echo "PORT=30121" >> $GITHUB_ENV
    #       echo "USER_NAME=edexauniverse" >> $GITHUB_ENV
    #       echo "DEST_DIR=/home/edexauniverse/github-actions/python-app/helmtemplate" >> $GITHUB_ENV
    #       echo "ROOT_DIR=/home/edexauniverse/github-actions/python-app" >> $GITHUB_ENV
    #     else
    #       echo "Unsupported branch: ${{ github.ref_name }}"
    #       exit 1
    #     fi

    # - name: Executing remote SSH commands using SSH key
    #   env:
    #     REPO_NAME: ${{ github.event.repository.name }}
    #   uses: appleboy/ssh-action@v1.2.0
    #   with:
    #     host: 80.248.196.125
    #     username: ${{ env.USER_NAME }}
    #     key: ${{ secrets.SSH_PRIVATE_KEY }}
    #     port: ${{ env.PORT }}
    #     script: |
    #       #!/bin/bash

    #       # Define variables based on branch
    #       destDir="${{ env.DEST_DIR }}"
    #       rootDir="${{ env.ROOT_DIR }}"
    #       ProjectName="${{ env.REPO_NAME }}"
    #       tag="${{ env.commit_sha }}"

    #       # Update Chart.yaml
    #       /usr/local/bin/yq e ".name = \"$ProjectName\"" -i "$destDir/Chart.yaml"
    #       /usr/local/bin/yq e ".appVersion = \"$tag\"" -i "$destDir/Chart.yaml"

    #       # Execute collect_host_alias.sh
    #       /bin/bash "$rootDir/collect_host_alias.sh" "$rootDir"

    #       # Helm upgrade
    #       /usr/local/bin/helm upgrade "$ProjectName" --install "$destDir" --set deployment.imagetag="$tag"

    # - name: executing remote ssh commands using ssh key
    #   env:
    #     REPO_NAME: ${{ github.event.repository.name }}
    #   uses: appleboy/ssh-action@v1.2.0
    #   with:
    #     host: 80.248.196.125
    #     username: ${{ env.USER_NAME }}
    #     key: ${{ secrets.SSH_PRIVATE_KEY }}
    #     port: ${{ env.PORT }}
    #     script: |
    #       #!/bin/bash

    #       # Define variables
    #       destDir="/home/ubuntu/github-actions/python-app/helmtemplate"
    #       root="/home/ubuntu/github-actions/python-app"
    #       ProjectName="${{ env.REPO_NAME }}"
    #       tag="${{ env.commit_sha }}"

    #       # Update Chart.yaml
    #       /usr/local/bin/yq e ".name = \"$ProjectName\"" -i "$destDir/Chart.yaml"
    #       /usr/local/bin/yq e ".appVersion = \"$tag\"" -i "$destDir/Chart.yaml"

    #       # Execute collect_host_alias.sh
    #       /bin/bash "$root/collect_host_alias.sh" "$root"

    #       # Helm upgrade
    #       /usr/local/bin/helm upgrade "$ProjectName" --install "$destDir" --set deployment.imagetag="$tag"
